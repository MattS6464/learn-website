<script>
    import * as Plot from '@observablehq/plot';
    import * as Tone from 'tone';
    import { onMount } from 'svelte';
    import { LTTB } from 'downsample';
    import normalize from 'array-normalize';
    import _ from 'lodash';
    
    let data;
    let container;
    let ds;

    const abs = (arr) => arr.map(d => Math.abs(d))
    onMount(async() => {

        const buf = new Tone.ToneAudioBuffer(); 
        await buf.load('/drum.wav');

        let pitch = '258.965485 178.696686 178.14859 398.956665 184.579178 181.958038 179.246735 178.929443 177.950836 533.465942 271.30368 541.953369 270.024414 270.548462 533.190552 519.940918 6155.041992 5967.296875 5961.427734 107.157768 135.336563 582.148682 578.655701 551.577515 576.480652 573.94 571.218323 575.338379 574.562988 173.686356 180.260345 175.501297 179.395798 172.955948 172.897659 187.248642 140.913269 265.586792 4487.915039 4889.45752 4532.648438 173.598953 4585.29541 4287.556152 4353.4 5625.172852 5357.412109 265.033295 5403.535645 5638.188965 265.636932 515.51947 511.107147 505.063995 630.620728 2106.45752 265.514954 727.543396 501.012146 140.603836 187.283157 4461.643555 4754.145996 2358.888672 2342.610107 180.0522 584.398254 187.787247 638.96582 502.484222 687.820984 132.903732 639.426636 1463.996338 5636.052246 87.382843 6442.835938 8921.689453 4854.45166 5023.637207 2269.561523 4090.113037 4908.498535 88.504425 5395.32959 4887.756348 3988.118408 5599.964844 187.927414 4389.776855 158.978149 172.235138 165.105652 159.14447 187.598846 3126.250244 3169.828857 9775.541992 9457.017578 156.401184 275.162781 273.059265 180.23555 179.057068 178.671494 178.87413 542.834106 540.124451 549.5224 542.978333 540.44 540.1521 538.361389 543.226318 542.733948 544.443115 540.005737 539.8573 540.145813 544.087708 536.079712 538.942261 539.448242 540.710876 543.211853 535.392212 534.832092 272.604218 532.289307 538.649597 537.856506 537.802856 274.453644 268.675171 274.402222 178.831299 400.916473 179.952927 177.381439 177.359558 178.397537 179.076538 556.372009 553.478821 550.979736 549.901672 544.798096 541.60144 544.648071 546.488159 573.281311 572.618225 556.450989 556.373779 548.814392 545.415039 541.792847 551.53772 542.59 547.342346 182.70401 269.81 176.923553 177.015198 177.112778 177.705109 177.95224 177.701462 274.390808 277.45636 279.310181 279.896759 113.152779 5950.147949 0. 814.61554 189.351776 108.495506 0. 147.888336 0. 91.523232 0. 122.052979 168.772949 169.148941 182.862869 144.23 162.750656 169.56073 168.508469 174.084244 162.472824 173.630402 145.803543 170.417847 5849.418945 6271.930176 4712.138184 6217.514648 166.703247 143.77066 140.456757 177.774078 6826.787109 132.512833 108.973969 135.302292 135.142532 173.544266 138.015198 128.234177 132.820984 147.898422 164.880524 156.442184 169.439362 137.684479 175.885666 153.143143 173.602112 149.305771 165.765884 91.991837 423.257019 265.981598 181.694916 177.963654 177.598846 178.052338 270.921844 273.916321 270.8 276.345551 273.187439 275.029388 272.660217 269.12384 271.253326 270.944092 272.215393 272.508362 271.483368 535.51825 535.30835 529.296082 537.34 270.082581 532.97 281.140717 265.534058 272.463348 272.491028 530.04248 177.572983 272.558289'
        pitch = pitch.split(' ')
        pitch = normalize(pitch.map(v => parseFloat(v)));
        pitch = pitch.map((v, i) => [i, parseFloat(v)] );
        let rawData = buf.toArray();
        
        let untypedArr = new Array(rawData.length);
        
        rawData.forEach((d, i) => {
            untypedArr[i] = rawData[i] 
        })
        let mag = abs(untypedArr);
        let db = mag.map(v => 20 * Math.log10(v))

        mag = mag.map((d, i) => [i, d]);

        let ampDS = LTTB(mag, pitch.length);
        ampDS = ampDS.map((d, i) => [i, d[1]])
        
        let dbvals = ampDS.map(d => Math.max(20 * Math.log10(d[1]), -60))
        let dbnorm = normalize(dbvals);

        db = dbnorm.map((d,i) => [i, d])
        

        let p = Plot.plot({
            marks: [
                Plot.line(ampDS, { stroke: 'rgba(89, 156, 44, 1)', fill: 'rgba(89, 156, 44, 1)'}),
                Plot.line(pitch, { stroke: 'rgba(63, 40, 193, 0.25)' }),
            ],
            style: { 
                background: "white",
            }
        });

        container.append(p)
    })
</script>

<div class='container' bind:this={container}></div>

<style>
    .container {
        font-family: sans-serif;
        font-size: 11px;
    }

    p {
        color: rgba(63, 40, 193, 0.409)
    }
</style>